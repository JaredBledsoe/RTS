<html>
<head>
<style>
  body {
    margin: 0;
  }
  canvas {
/*    background-color: blue;
*/  }
  img {
    position: absolute;
    display: none;
  }
</style>
</head>
<body>
<img id="arrow" src="https://d30y9cdsu7xlg0.cloudfront.net/png/34-200.png">
<img id="head" src="https://minotar.net/helm/80.png">

<canvas></canvas>
  
<script>





var HOST = location.origin.replace(/^http/, 'ws');

//Online
var ws = new WebSocket(HOST);

//Local
//var ws = new WebSocket('ws://localhost:3000');

var canvas = document.getElementsByTagName('canvas')[0];
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
var ctx = canvas.getContext('2d');
var keyStates = [];

var grids = [];
var player;
var arrow = document.getElementById('arrow');
var head = document.getElementById('head');


window.onunload = function () {
 ws.send(JSON.stringify({
     type: 'close',
     id: player.id
    }));
};





ws.onmessage = function(e) {
  var message = JSON.parse(e.data);

  if (message.type == 'gameUpdate') {
    player.control();
    //Move viewport to center player
    player.camera(player.gridId, message.player.gridId);
    player.gridId = message.player.gridId;
    player.x = message.player.x;
    player.y = message.player.y;
    grids = message.grids;
    console.log(grids);

    if (player.updated == true) {
      player.updated = false;
      ws.send(JSON.stringify({
        type: 'playerUpdate',
        info: player
      }));
    }

    //Executes all drawing
    player.camera();
  }


  //Player just joined
  else if (message.type == 'initPlayer') {
    ctx.translate(canvas.width/2, canvas.height/2);
    player = new Players(message.player.x, message.player.y, message.player.id, message.player.moves, message.player.gridId);
  }
} 





function Players(x, y, id, moves, gridId) {
  this.x = x;
  this.y = y;
  this.id = id;
  this.moves = moves;
  this.gridId = gridId;
  this.updated = false;

  this.control = function() {
    if (keyStates[38] || keyStates[87]) {
      this.moves[0] = true;
    }
    else {
      this.moves[0] = false;
    }
    if (keyStates[39] || keyStates[68]) {
      this.moves[1] = true;
    }
    else {
      this.moves[1] = false;
    }
    if (keyStates[40] || keyStates[83]) {
      this.moves[2] = true;
    }
    else {
      this.moves[2] = false;
    }
    if (keyStates[37] || keyStates[65]) {
      this.moves[3] = true;
    }
    else {
      this.moves[3] = false;
    }
  };

  this.camera = function(oldId, newId) {
    ctx.clearRect(player.x-canvas.width/1.5, player.y-canvas.width/1.5, player.x+canvas.width*2, player.y+canvas.height*2);

    if (newId == oldId-1) {
      ctx.translate(0, 50);
    }
    else if (newId == oldId+1) {
      ctx.translate(0, -50);
    }
    else if (newId == oldId+100) {
      ctx.translate(-50, 0);
    }
    else if (newId == oldId-100) {
      ctx.translate(50, 0);
    }

    for (var i=0; i<grids.length; i++) {
      draw(grids[i].x, grids[i].y, grids[i].owner, grids[i].gridId, grids[i].rgb);
    }
  };
};





function draw(x, y, owner, gridId, rgb) {
  ctx.beginPath();
  ctx.rect(x, y, 50, 50);
  if (gridId === player.gridId) {
    ctx.fillStyle = 'rgba(' + rgb[0] + ',' + rgb[1] + ',' +  rgb[2] + ', .5)';
    ctx.fill();
    ctx.drawImage(head, x+7, y+7, 36, 36);
  }
  else if (owner === player.id) {
    ctx.fillStyle = 'rgba(' + rgb[0] + ',' + rgb[1] + ',' +  rgb[2] + ', .5)';
    ctx.fill();
  }
  else if (owner !== player.id && typeof owner == 'number') {
    ctx.fillStyle = 'rgba(' + rgb[0] + ',' + rgb[1] + ',' +  rgb[2] + ', .5)';
    ctx.fill();
  }
  else if (owner === true) {
    // ctx.drawImage(arrow, x, y, 50, 50);
    var alpha = 0;
    var claim = setInterval(function() {
      alpha += .1;
      ctx.fillStyle = 'rgba(255, 255, 102,' + alpha + ')';
      ctx.fill();

      if (alpha > 1) {
        clearInterval(claim);
      }
    },10);
  }

  // ctx.stroke();
}





window.addEventListener('keydown', function(e) {
  keyStates[e.keyCode] = true;
  player.updated = true;
});
window.addEventListener('keyup', function(e) {
  keyStates[e.keyCode] = false;
  player.updated = true;
});





</script>
</body>
</html>
