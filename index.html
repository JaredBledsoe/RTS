<html>
<head>
<style>
  body {
    margin: 0;
    user-select: none;
  }
  img {
    position: absolute;
    display: none;
  }
  canvas {
    background-image: url('http://2.bp.blogspot.com/_Ql_VVzn3j9g/R9kXMzpPrcI/AAAAAAAAAbY/UrjCymSWtiU/s1600/461223182.jpg');
  }
  #hud {
    position: absolute;
    left: 50%;
    transform: translate(-50%, 0);
    height: 50px;
    bottom: 5%;
    white-space: nowrap;
  }
  #controls {
    width: 500px;
    height: 500px;
    position: absolute;
    background-image: url('../public/images/controls.png');
    top: 5px;
    left: 5px;
  }
  .slot {
    width: 80px;
    height: 80px;
    display: inline-block;
    box-shadow: inset 0px 0px 15px 5px rgba(0,0,0,0.75);
    background-color: rgba(0, 0, 0, .25);
    font-size: 20px;
    color: white;
  }
  .select {
    background-color: rgba(255, 255, 255, .25);
  }
</style>
</head>
<body>
<img id="head" src="http://lawebloca.com/wp-content/uploads/2012/10/minecraft-creeper-face1.jpg">

<img id="rock1" src="http://rtstextures.bitballoon.com/rock1.png">
<img id="rock2" src="http://rtstextures.bitballoon.com/rock2.png">
<img id="rock3" src="http://rtstextures.bitballoon.com/rock3.png">
<img id="rock4" src="http://rtstextures.bitballoon.com/rock4.png">
<img id="rock5" src="https://i.pinimg.com/736x/2e/f4/71/2ef471c9d20d2a040816906288f92992--floor-texture-rock-texture.jpg">

<img id="crack1" src="http://www.textures4photoshop.com/tex/thumbs/crack-texture-png-free-thumb22.png">
<img id="crack2" src="http://www.textures4photoshop.com/tex/thumbs/cracked-wall-PNG-texture-thumb24.png">
<img id="crack3" src="http://www.textures4photoshop.com/tex/thumbs/broken-mirror-with-glass-shards-png-608.png">

<canvas id="game"></canvas>
  
<!-- <div id="controls"><image src="public/images/controls.png"></div>
 -->
<div id="hud">
  <div class="slot" style="background-image: url('http://rtstextures.bitballoon.com/rock1.png')"></div>
  <div class="slot" style="background-image: url('http://rtstextures.bitballoon.com/rock2.png')"></div>
  <div class="slot" style="background-image: url('http://rtstextures.bitballoon.com/rock3.png')"></div>
  <div class="slot" style="background-image: url('http://rtstextures.bitballoon.com/rock4.png')"></div>
  <div class="slot"></div>
  <div class="slot"></div>
  <div class="slot"></div>
  <div class="slot"></div>
</div>


<script>





var HOST = location.origin.replace(/^http/, 'ws');

//Online
var ws = new WebSocket(HOST);

//Local
//ws = new WebSocket('ws://localhost:3000');

var canvas = document.getElementById('game');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

window.addEventListener("resize", function() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;  
});

var ctx = canvas.getContext('2d');

var keyStates = [];
var grids = [];
var player;
var arrow = document.getElementById('arrow');
var head = document.getElementById('head');

var rock1 = document.getElementById('rock1');
var rock2 = document.getElementById('rock2');
var rock3 = document.getElementById('rock3');
var rock4 = document.getElementById('rock4');
var rock5 = document.getElementById('rock5');

var crack1 = document.getElementById('crack1');
var crack2 = document.getElementById('crack2');
var crack3 = document.getElementById('crack3');

// window.onunload = function () {
//  ws.send(JSON.stringify({
//      type: 'close',
//      id: player.id
//     }));
// };










ws.onmessage = function(e) {
  var message = JSON.parse(e.data);
  if (message.type == 'gameUpdate') {
    //Move viewport to center player
    player.gridId = message.player.gridId;
    player.updatedGrids = message.updatedGrids;
    player.viewStartGrid = message.player.viewStartGrid;
    player.viewEndGrid = message.player.viewEndGrid;


    // if (player.smooth[0] === 0) {
      player.x = message.player.x;
      player.y = message.player.y;

      // player.smooth = message.player.smooth;
    // }
    
    player.control();
    if (player.updated == true) {
      player.updated = false;
      ws.send(JSON.stringify({
        type: 'playerUpdate',
        info: player
      }));
    }

    //Executes all drawing
    player.camera();
  }

  //Player claimed a grid
  else if (message.type == 'claimGrid') {
    HUD.draw(undefined, message.grid.rock);
  }

  //Player just joined
  else if (message.type == 'initPlayer') {
    player = new Players(message.player.x, message.player.y, message.player.id, message.player.moves, message.player.gridId);
    grids = message.grids;

    ctx.setTransform(1, 0, 0, 1, -player.x+canvas.width/2, -player.y+canvas.height/2);

    ws.send(JSON.stringify({
      type: 'initPlayer',
      info: player
    })); 
  }
} 










function Players(x, y, id, moves, gridId) {
  this.x = x;
  this.y = y;
  this.id = id;
  this.moves = moves;
  this.gridId = gridId;
  this.updated = false;
  this.smoothMoving = false;
  this.smooth = [0, 0, 0, 0];
  this.updatedGrids = [];
  this.viewStartGrid;
  this.viewEndGrid;
  this.canvasWidth = canvas.width;
  this.canvasHeight = canvas.height;


  this.control = function() {

    if (keyStates[38] || keyStates[87]) {
      this.moves[0] = true;
    }
    else {
      this.moves[0] = false;
    }
    if (keyStates[39] || keyStates[68]) {
      this.moves[1] = true;
    }
    else {
      this.moves[1] = false;
    }
    if (keyStates[40] || keyStates[83]) {
      this.moves[2] = true;
    }
    else {
      this.moves[2] = false;
    }
    if (keyStates[37] || keyStates[65]) {
      this.moves[3] = true;
    }
    else {
      this.moves[3] = false;
    }
  };

  this.camera = function() {

    ctx.setTransform(1, 0, 0, 1, -this.x+canvas.width/2, -this.y+canvas.height/2);

    for (var i=0; i<this.updatedGrids.length; i++) {
      if (this.updatedGrids[i]) {
        grids[this.updatedGrids[i].gridId] = this.updatedGrids[i];
      }
    }
        
    ctx.clearRect(player.x-canvas.width/2, player.y-canvas.height/2, canvas.width, canvas.height);

    for (var i=this.viewStartGrid; i<this.viewEndGrid; i++) {
      draw(i);
    }

    ctx.drawImage(head, this.x+7, this.y+7, 36, 36);

  };
};










var HUD = {
  slot1: 0,
  slot2: 0,
  slot3: 0,
  slot4: 0,
  slot5: 0,
  slot6: 0,
  slot7: 0,
  slot8: 0,

  draw: function(selectSlot, claimGrid) {
    if (selectSlot) {
      for (var i=0; i<8; i++) {
        if (i != selectSlot-49) {
          document.getElementsByClassName('slot')[i].classList.remove('select');    
        }
        else if (i == selectSlot-49) {
          if (document.getElementsByClassName('slot')[i].classList.contains('select')) {
            document.getElementsByClassName('slot')[i].classList.remove('select');    
          }
          else {
            document.getElementsByClassName('slot')[i].classList.add('select');    
          }
        }
      }
    }
    else if (claimGrid) {
      claimGrid <= 75 ? this.slot1++ : 
      claimGrid <= 95 ? this.slot2++ : 
      claimGrid <= 99 ? this.slot3++ :
      claimGrid == 100 ? this.slot4++ : this.slot5++;
    

      for (var i=1; i<9; i++) {
        var slot = 'this.slot'.concat(i);
        document.getElementsByClassName('slot')[i-1].innerHTML = eval(slot);
      }
    }
  },

  slotUpdater: function() {
    for (var i=1; i<8; i++) {
      var slot = 'slot'.concat(i);

      this.slot.addEventListener('change', function() {
      });
    }
  }
}




function draw(index) {

  ctx.beginPath();

  //Textured rocks
  if (grids[index].owner === false || grids[index].contesting === true) {
    var rock = grids[index].rock <= 75 ? rock1 : 
               grids[index].rock <= 95 ? rock2 : 
               grids[index].rock <= 99 ? rock3 :
               grids[index].rock == 100 ? rock4 : rock5;

      ctx.drawImage(rock, grids[index].x, grids[index].y, 50, 50);
  }

  //Player or their path
  ctx.rect(grids[index].x, grids[index].y, 50, 50);
  if (grids[index].occupied === true && grids[index].owner != player.id) {
    ctx.fillStyle = 'rgba(' + grids[index].rgb[0] + ',' + grids[index].rgb[1] + ',' +  grids[index].rgb[2] + ', .75)';
    ctx.fill();
    ctx.save();
    ctx.drawImage(head, grids[index].x+7, grids[index].y+7, 36, 36);
    ctx.restore();
  }
  else if (typeof grids[index].owner === 'number') {
    ctx.fillStyle = 'rgba(' + grids[index].rgb[0] + ',' + grids[index].rgb[1] + ',' +  grids[index].rgb[2] + ', .75)';
    ctx.fill();
  }

  //Rock being mined
  if (grids[index].owner === true) {
    ctx.drawImage(eval('crack'.concat(grids[index].cracks+1)), grids[index].x, grids[index].y, 50, 50);
  }
}










window.addEventListener('keydown', function(e) {
  // e.preventDefault();
  player.updated = true;

  if (e.keyCode >= 37 && e.keyCode <= 40 || e.keyCode == 87 || e.keyCode == 83  || e.keyCode == 65  || e.keyCode == 68) {
    keyStates[37] = false;
    keyStates[38] = false;
    keyStates[39] = false;
    keyStates[40] = false;
    keyStates[87] = false;
    keyStates[83] = false;
    keyStates[65] = false;
    keyStates[67] = false;
    keyStates[e.keyCode] = true;
  }
});
window.addEventListener('keyup', function(e) {
  // e.preventDefault();
    keyStates[e.keyCode] = false;

  player.updated = true;
});





</script>
</body>
</html>
