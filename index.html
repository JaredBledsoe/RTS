<html>
<head>
<style>
  body {
    margin: 0;
  }
  img {
    position: absolute;
    display: none;
  }
  canvas {
    background-image: url('http://2.bp.blogspot.com/_Ql_VVzn3j9g/R9kXMzpPrcI/AAAAAAAAAbY/UrjCymSWtiU/s1600/461223182.jpg');
  }
</style>
</head>
<body>
<img id="arrow" src="https://d30y9cdsu7xlg0.cloudfront.net/png/34-200.png">
<img id="head" src="http://lawebloca.com/wp-content/uploads/2012/10/minecraft-creeper-face1.jpg">
<img class="rock" src={require("images/1.png")}>
<!-- <img class="rock" src="images/2.png">
<img class="rock" src="images/3.png">
<img class="rock" src="images/4.png">
 -->

<canvas></canvas>
  
<script>





var HOST = location.origin.replace(/^http/, 'ws');

//Online
var ws = new WebSocket(HOST);

//Local
//ws = new WebSocket('ws://localhost:3000');

var canvas = document.getElementsByTagName('canvas')[0];
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

window.addEventListener("resize", function() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;  
});

var ctx = canvas.getContext('2d');
var keyStates = [];

var grids = [];
var player;
var arrow = document.getElementById('arrow');
var head = document.getElementById('head');

var rock1 = new Image();
rock1.src = 'https://opengameart.org/sites/default/files/styles/medium/public/oga-textures/461223139.jpg';
var rock2 = new Image();
rock2.src = 'http://3.bp.blogspot.com/_Ql_VVzn3j9g/R9kVfDpPrYI/AAAAAAAAAa8/xxBZQqZMhoI/s1600/461223179.jpg';
var rock3 = new Image();
rock3.src = 'https://opengameart.org/sites/default/files/styles/medium/public/oga-textures/tileable2b.png';
var rock4 = new Image();
rock4.src = 'http://2.bp.blogspot.com/_Ql_VVzn3j9g/R9kVdzpPrWI/AAAAAAAAAas/L0nLJQTx_wk/s1600/461223177.jpg';
var rock5 = new Image();
rock5.src = 'https://i.pinimg.com/736x/2e/f4/71/2ef471c9d20d2a040816906288f92992--floor-texture-rock-texture.jpg';

var crack1 = new Image();
crack1.src = 'http://www.textures4photoshop.com/tex/thumbs/crack-texture-png-free-thumb22.png';
var crack2 = new Image();
crack2.src = 'http://www.textures4photoshop.com/tex/thumbs/cracked-wall-PNG-texture-thumb24.png';
var crack3 = new Image();
crack3.src = 'http://www.textures4photoshop.com/tex/thumbs/broken-mirror-with-glass-shards-png-608.png';

window.onunload = function () {
 ws.send(JSON.stringify({
     type: 'close',
     id: player.id
    }));
};





ws.onmessage = function(e) {
  var message = JSON.parse(e.data);
  if (message.type == 'gameUpdate') {
    player.control();
    //Move viewport to center player
    player.camera(player.gridId, message.player.gridId);
    player.gridId = message.player.gridId;
    player.x = message.player.x;
    player.y = message.player.y;
    
    grids = message.grids;

    if (player.updated == true) {
      player.updated = false;
      ws.send(JSON.stringify({
        type: 'playerUpdate',
        info: player
      }));
    }

    //Executes all drawing
    player.camera();
  }


  //Player just joined
  else if (message.type == 'initPlayer') {
    ctx.translate(canvas.width/2, canvas.height/2);
    player = new Players(message.player.x, message.player.y, message.player.id, message.player.moves, message.player.gridId);
  }
} 





function Players(x, y, id, moves, gridId) {
  this.x = x;
  this.y = y;
  this.id = id;
  this.moves = moves;
  this.gridId = gridId;
  this.updated = false;

  this.control = function() {
    if (keyStates[38] || keyStates[87]) {
      this.moves[0] = true;
    }
    else {
      this.moves[0] = false;
    }
    if (keyStates[39] || keyStates[68]) {
      this.moves[1] = true;
    }
    else {
      this.moves[1] = false;
    }
    if (keyStates[40] || keyStates[83]) {
      this.moves[2] = true;
    }
    else {
      this.moves[2] = false;
    }
    if (keyStates[37] || keyStates[65]) {
      this.moves[3] = true;
    }
    else {
      this.moves[3] = false;
    }
  };

  this.camera = function(oldId, newId) {
    ctx.clearRect(player.x-canvas.width/1.5, player.y-canvas.width/1.5, player.x+canvas.width*2, player.y+canvas.height*2);
    ctx.setTransform(1, 0, 0, 1, 0, 0);7
    ctx.translate(-player.x+canvas.width/2, -player.y+canvas.height/2);


    // if (newId == oldId-1) {
    //   console.log("UP");
    //   ctx.translate(player.x, player.y);
    // }
    // else if (newId == oldId+1) {
    //   console.log("DOWN");
    //   ctx.translate(player.x, player.y);
    // }
    // else if (newId == oldId+100) {
    //   console.log("RIGHT");
    //   ctx.translate(player.x, player.y);
    // }
    // else if (newId == oldId-100) {
    //   console.log("LEFT");
    //   ctx.translate(player.x, player.y);
    // }

    for (var i=0; i<grids.length; i++) {
      draw(i);
    }
  };
};





function draw(index) {

  ctx.beginPath();

  if (grids[index].owner.typeof != 'number') {
    if (grids[index].rock <= 75) {
      ctx.drawImage(rock1, grids[index].x, grids[index].y, 50, 50);
    }
    else if (grids[index].rock <= 95) {
      ctx.drawImage(rock2, grids[index].x, grids[index].y, 50, 50);
    }
    else if (grids[index].rock <= 99) {
      ctx.drawImage(rock3, grids[index].x, grids[index].y, 50, 50);
    }
    else if (grids[index].rock <= 100) {
      ctx.drawImage(rock4, grids[index].x, grids[index].y, 50, 50);
    }
    else if (grids[index].rock == 101) {
      ctx.drawImage(rock5, grids[index].x, grids[index].y, 50, 50);
    }
  }

  ctx.rect(grids[index].x, grids[index].y, 50, 50);
  if (grids[index].occupied === true) {
    ctx.fillStyle = 'rgba(' + grids[index].rgb[0] + ',' + grids[index].rgb[1] + ',' +  grids[index].rgb[2] + ', .65)';
    ctx.fill();
    ctx.save();
    ctx.shadowBlur = Math.random()*3+10;
    ctx.shadowColor = 'black';

    ctx.drawImage(head, grids[index].x+7+(Math.floor(Math.random()*2)-1), grids[index].y+7+(Math.floor(Math.random()*2)-1), 36, 36);
    ctx.restore();
  }
  else if (typeof grids[index].owner === 'number') {
    ctx.fillStyle = 'rgba(' + grids[index].rgb[0] + ',' + grids[index].rgb[1] + ',' +  grids[index].rgb[2] + ', .65)';
    ctx.fill();
  }

  if (grids[index].owner === true) {
    if (grids[index].cracks == 0) {
      ctx.drawImage(crack1, grids[index].x, grids[index].y, 50, 50);
    }
    else if (grids[index].cracks == 1) {
      ctx.drawImage(crack1, grids[index].x, grids[index].y, 50, 50);
      ctx.drawImage(crack2, grids[index].x, grids[index].y, 50, 50);
    }
    else if (grids[index].cracks == 2) {
      ctx.drawImage(crack1, grids[index].x, grids[index].y, 50, 50);
      ctx.drawImage(crack2, grids[index].x, grids[index].y, 50, 50);
      ctx.drawImage(crack3, grids[index].x, grids[index].y, 50, 50);
    }
  }

}





window.addEventListener('keydown', function(e) {
  keyStates[e.keyCode] = true;
  player.updated = true;
});
window.addEventListener('keyup', function(e) {
  keyStates[e.keyCode] = false;
  player.updated = true;
});





</script>
</body>
</html>
