<html>
<head>
<style>
  body {
    margin: 0;
  }
  img {
    position: absolute;
    display: none;
  }
</style>
</head>
<body>
<img id="arrow" src="https://d30y9cdsu7xlg0.cloudfront.net/png/34-200.png">
<img id="head" src="https://minotar.net/helm/80.png">

<canvas></canvas>
  
<script>





var HOST = location.origin.replace(/^http/, 'ws');

//Online
var ws = new WebSocket(HOST);

//Local
//ws = new WebSocket('ws://localhost:3000');

var canvas = document.getElementsByTagName('canvas')[0];
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

window.addEventListener("resize", function() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;  
});

var ctx = canvas.getContext('2d');
var keyStates = [];

var grids = [];
var player;
var arrow = document.getElementById('arrow');
var head = document.getElementById('head');


window.onunload = function () {
 ws.send(JSON.stringify({
     type: 'close',
     id: player.id
    }));
};





ws.onmessage = function(e) {
  var message = JSON.parse(e.data);
  if (message.type == 'gameUpdate') {
    player.control();
    //Move viewport to center player
    player.camera(player.gridId, message.player.gridId);
    player.gridId = message.player.gridId;
    player.x = message.player.x;
    player.y = message.player.y;
    
    grids = message.grids;
    console.log(grids.length);

    if (player.updated == true) {
      player.updated = false;
      ws.send(JSON.stringify({
        type: 'playerUpdate',
        info: player
      }));
    }

    //Executes all drawing
    player.camera();
  }


  //Player just joined
  else if (message.type == 'initPlayer') {
    ctx.translate(canvas.width/2, canvas.height/2);
    player = new Players(message.player.x, message.player.y, message.player.id, message.player.moves, message.player.gridId);
  }
} 





function Players(x, y, id, moves, gridId) {
  this.x = x;
  this.y = y;
  this.id = id;
  this.moves = moves;
  this.gridId = gridId;
  this.updated = false;

  this.control = function() {
    if (keyStates[38] || keyStates[87]) {
      this.moves[0] = true;
    }
    else {
      this.moves[0] = false;
    }
    if (keyStates[39] || keyStates[68]) {
      this.moves[1] = true;
    }
    else {
      this.moves[1] = false;
    }
    if (keyStates[40] || keyStates[83]) {
      this.moves[2] = true;
    }
    else {
      this.moves[2] = false;
    }
    if (keyStates[37] || keyStates[65]) {
      this.moves[3] = true;
    }
    else {
      this.moves[3] = false;
    }
  };

  this.camera = function(oldId, newId) {
    ctx.clearRect(player.x-canvas.width/1.5, player.y-canvas.width/1.5, player.x+canvas.width*2, player.y+canvas.height*2);
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.translate(-player.x+canvas.width/2, -player.y+canvas.height/2);


    // if (newId == oldId-1) {
    //   console.log("UP");
    //   ctx.translate(player.x, player.y);
    // }
    // else if (newId == oldId+1) {
    //   console.log("DOWN");
    //   ctx.translate(player.x, player.y);
    // }
    // else if (newId == oldId+100) {
    //   console.log("RIGHT");
    //   ctx.translate(player.x, player.y);
    // }
    // else if (newId == oldId-100) {
    //   console.log("LEFT");
    //   ctx.translate(player.x, player.y);
    // }

    for (var i=0; i<grids.length; i++) {
      draw(i);
    }
  };
};





function draw(index) {
  ctx.beginPath();
  ctx.rect(grids[index].x, grids[index].y, 50, 50);
  if (grids[index].occupied === true) {
    ctx.fillStyle = 'rgba(' + grids[index].rgb[0] + ',' + grids[index].rgb[1] + ',' +  grids[index].rgb[2] + ', .5)';
    ctx.fill();
    ctx.drawImage(head, grids[index].x+7, grids[index].y+7, 36, 36);
  }
  else if (typeof grids[index].owner === 'number' ) {
    ctx.fillStyle = 'rgba(' + grids[index].rgb[0] + ',' + grids[index].rgb[1] + ',' +  grids[index].rgb[2] + ', .5)';
    ctx.fill();
  }
  ctx.stroke();
}





window.addEventListener('keydown', function(e) {
  keyStates[e.keyCode] = true;
  player.updated = true;
});
window.addEventListener('keyup', function(e) {
  keyStates[e.keyCode] = false;
  player.updated = true;
});





</script>
</body>
</html>
